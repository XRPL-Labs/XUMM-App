/**
 * Add Currency Screen
 */

import { head, first, forEach, isEmpty, get } from 'lodash';

import React, { Component } from 'react';
import { Animated, View, Text, Image, TouchableWithoutFeedback, TouchableOpacity, ScrollView } from 'react-native';

import Interactable from 'react-native-interactable';

import { Navigator } from '@common/helpers/navigator';
import { AppScreens } from '@common/constants';

import { Payload } from '@common/libs/payload';
import { CounterPartyRepository } from '@store/repositories';
import { CounterPartySchema, CurrencySchema, AccountSchema } from '@store/schemas/latest';

// components
import { Button, Footer } from '@components/General';

import Localize from '@locale';

// style
import { AppStyles, AppSizes } from '@theme';
import styles from './styles';

/* types ==================================================================== */
export interface Props {
    account: AccountSchema;
}

export interface CurrenciesList {
    [key: string]: CurrencySchema[];
}

export interface State {
    counterParties: CounterPartySchema[];
    currencies: CurrenciesList;
    selectedCurrency: CurrencySchema;
    selectedParty: CounterPartySchema;
}

/* Component ==================================================================== */
class AddCurrencyOverlay extends Component<Props, State> {
    static screenName = AppScreens.Overlay.AddCurrency;

    panel: any;
    deltaY: Animated.Value;
    deltaX: Animated.Value;
    isOpening: boolean;

    static options() {
        return {
            statusBar: {
                visible: true,
                style: 'light',
            },
            topBar: {
                visible: false,
            },
        };
    }

    constructor(props: Props) {
        super(props);

        this.state = {
            counterParties: undefined,
            currencies: undefined,
            selectedParty: undefined,
            selectedCurrency: undefined,
        };

        this.deltaY = new Animated.Value(AppSizes.screen.height);
        this.deltaX = new Animated.Value(0);

        this.isOpening = true;
    }

    componentDidMount() {
        this.setDefaults();
        this.slideUp();
    }

    setDefaults = () => {
        const { account } = this.props;

        const counterParties = CounterPartyRepository.query({ shortlist: true }) as any;

        if (counterParties.isEmpty()) return;

        const availableParties = [] as CounterPartySchema[];
        const availableCurrencies = [] as any;

        forEach(counterParties, (counterParty) => {
            const currencies = [] as any;

            forEach(counterParty.currencies, (currency) => {
                if (!account.hasCurrency(currency) && currency.shortlist === true) {
                    currencies.push(currency);
                }
            });

            if (!isEmpty(currencies)) {
                availableParties.push(counterParty);

                availableCurrencies[counterParty.id] = currencies;
            }
        });

        this.setState({
            counterParties: availableParties,
            currencies: availableCurrencies,
            selectedParty: head(availableParties),
            selectedCurrency: head(get(availableCurrencies, head(availableParties)?.id)),
        });
    };

    addCurrency = async () => {
        const { selectedCurrency } = this.state;

        const payload = await Payload.build(
            {
                TransactionType: 'TrustSet',
                Flags: 131072, // tfSetNoRipple
                LimitAmount: { currency: selectedCurrency.currency, issuer: selectedCurrency.issuer, value: 999999999 },
            },
            Localize.t('asset.addingAssetReserveDescription'),
        );

        Navigator.showModal(
            AppScreens.Modal.ReviewTransaction,
            { modalPresentationStyle: 'fullScreen' },
            {
                payload,
            },
        );

        this.slideDown();
    };

    slideUp = () => {
        setTimeout(() => {
            if (this.panel) {
                this.panel.snapTo({ index: 1 });
            }
        }, 10);
    };

    slideDown = () => {
        setTimeout(() => {
            if (this.panel) {
                this.panel.snapTo({ index: 0 });
            }
        });
    };

    onAlert = (event: any) => {
        const { top, bottom } = event.nativeEvent;

        if (top && bottom) return;

        if (top === 'enter' && this.isOpening) {
            this.isOpening = false;
        }

        if (bottom === 'leave' && !this.isOpening) {
            Navigator.dismissOverlay();
        }
    };

    renderCurrencies = () => {
        const { counterParties, selectedParty, selectedCurrency, currencies } = this.state;

        if (isEmpty(counterParties)) {
            return (
                <Text style={[AppStyles.subtext, AppStyles.textCenterAligned]} adjustsFontSizeToFit numberOfLines={1}>
                    No Item to show
                </Text>
            );
        }

        return currencies[selectedParty.id].map((c, index) => {
            return (
                <TouchableOpacity
                    key={index}
                    style={[styles.listItem, selectedCurrency.id === c.id && styles.selectedRow]}
                    onPress={() => {
                        this.setState({
                            selectedCurrency: c,
                        });
                    }}
                >
                    <View style={[AppStyles.flex3, AppStyles.row, AppStyles.centerAligned]}>
                        <View style={[AppStyles.flex1]}>
                            <Image style={[styles.currencyAvatar]} source={{ uri: c.avatar }} />
                        </View>
                        <View style={[AppStyles.flex3]}>
                            <Text
                                style={[AppStyles.subtext, selectedCurrency.id === c.id && styles.selectedText]}
                                adjustsFontSizeToFit
                                numberOfLines={1}
                            >
                                {c.name}
                            </Text>
                        </View>
                    </View>
                </TouchableOpacity>
            );
        });
    };

    renderParties = () => {
        const { counterParties, selectedParty, currencies } = this.state;

        if (isEmpty(counterParties)) {
            return (
                <Text
                    key="empty-parties"
                    style={[AppStyles.subtext, AppStyles.textCenterAligned]}
                    adjustsFontSizeToFit
                    numberOfLines={1}
                >
                    No Item to show
                </Text>
            );
        }

        return counterParties.map((c, index) => {
            if (!c?.isValid()) return null;

            const selected = selectedParty.id === c.id;

            return (
                <TouchableOpacity
                    key={index}
                    style={[styles.listItem, selected && styles.selectedRow]}
                    onPress={() => {
                        this.setState({
                            selectedParty: c,
                            selectedCurrency: first(get(currencies, c.id)),
                        });
                    }}
                >
                    <View style={[AppStyles.flex3, AppStyles.row, AppStyles.centerAligned]}>
                        <View style={[AppStyles.flex1]}>
                            <Image style={styles.avatar} source={{ uri: c.avatar }} />
                        </View>
                        <View style={[AppStyles.flex3]}>
                            <Text
                                style={[AppStyles.subtext, selected && styles.selectedText]}
                                adjustsFontSizeToFit
                                numberOfLines={1}
                            >
                                {c.name}
                                {c.name && ` (${currencies[c.id].length})`}
                            </Text>
                        </View>
                    </View>
                </TouchableOpacity>
            );
        });
    };

    renderContent = () => {
        const { selectedCurrency } = this.state;

        return (
            <View style={[styles.visibleContent, AppStyles.centerAligned]}>
                <View style={AppStyles.panelHeader}>
                    <View style={AppStyles.panelHandle} />
                </View>

                <View style={[AppStyles.row, AppStyles.centerAligned, AppStyles.paddingBottomSml]}>
                    <View style={[AppStyles.flex1, AppStyles.paddingLeftSml]}>
                        <Text numberOfLines={1} style={[AppStyles.h5, AppStyles.strong]}>
                            {Localize.t('asset.addAsset')}
                        </Text>
                    </View>
                    <View style={[AppStyles.row, AppStyles.flex1, AppStyles.paddingRightSml, AppStyles.flexEnd]}>
                        <Button
                            light
                            roundedSmall
                            isDisabled={false}
                            onPress={this.slideDown}
                            textStyle={[AppStyles.subtext, AppStyles.bold]}
                            label={Localize.t('global.cancel')}
                        />
                    </View>
                </View>
                <View style={[AppStyles.row, AppStyles.centerContent, AppStyles.marginBottomSml]}>
                    <Text numberOfLines={3} style={[AppStyles.p, AppStyles.subtext]}>
                        {Localize.t('asset.selectAnExchangeAndSelectAsset')}
                    </Text>
                </View>

                <View style={[AppStyles.row, AppStyles.paddingExtraSml]}>
                    <View style={[AppStyles.flex1]}>
                        <Text
                            numberOfLines={1}
                            style={[AppStyles.subtext, AppStyles.bold, AppStyles.textCenterAligned]}
                        >
                            {Localize.t('global.exchanges')}:
                        </Text>
                    </View>
                    <View style={styles.separator} />
                    <View style={[AppStyles.flex1]}>
                        <Text
                            numberOfLines={1}
                            style={[AppStyles.subtext, AppStyles.bold, AppStyles.textCenterAligned]}
                        >
                            {Localize.t('global.assets')}:
                        </Text>
                    </View>
                </View>
                <View style={[AppStyles.flex1, AppStyles.row]}>
                    <ScrollView style={[AppStyles.flex1]}>{this.renderParties()}</ScrollView>
                    <View style={styles.separator} />
                    <ScrollView style={[AppStyles.flex1]}>{this.renderCurrencies()}</ScrollView>
                </View>

                <Footer safeArea style={styles.footer}>
                    <Button
                        numberOfLines={1}
                        testID="add-and-sign-button"
                        block
                        isDisabled={!selectedCurrency}
                        onPress={this.addCurrency}
                        style={[AppStyles.buttonGreen]}
                        label={Localize.t('asset.addAndSign')}
                    />
                </Footer>
            </View>
        );
    };

    render() {
        return (
            <View testID="add-asset-overlay" style={AppStyles.flex1}>
                <TouchableWithoutFeedback onPress={this.slideDown}>
                    <Animated.View
                        style={[
                            AppStyles.shadowContent,
                            {
                                opacity: this.deltaY.interpolate({
                                    inputRange: [0, AppSizes.screen.height],
                                    outputRange: [0.9, 0],
                                    extrapolateRight: 'clamp',
                                }),
                            },
                        ]}
                    />
                </TouchableWithoutFeedback>

                <Interactable.View
                    ref={(r) => {
                        this.panel = r;
                    }}
                    animatedNativeDriver
                    onAlert={this.onAlert}
                    verticalOnly
                    snapPoints={[{ y: AppSizes.screen.height + 3 }, { y: AppSizes.heightPercentageToDP(10) }]}
                    boundaries={{ top: AppSizes.heightPercentageToDP(8) }}
                    alertAreas={[
                        { id: 'bottom', influenceArea: { bottom: AppSizes.screen.height } },
                        { id: 'top', influenceArea: { top: AppSizes.heightPercentageToDP(10) } },
                    ]}
                    initialPosition={{ y: AppSizes.screen.height }}
                    animatedValueY={this.deltaY}
                    animatedValueX={this.deltaX}
                >
                    {this.renderContent()}
                </Interactable.View>
            </View>
        );
    }
}

/* Export Component ==================================================================== */
export default AddCurrencyOverlay;
